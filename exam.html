<!DOCTYPE html>
<html>

<head>
    <title>Exam System</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 10px;
        }

        #exam-container {
            max-width: 800px;
            width: 95%;
            margin: 20px auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1,
        h2,
        h3,
        h4 {
            color: #2c3e50;
            margin-top: 0;
        }

        h1#exam-title {
            font-size: 1.8em;
            margin-bottom: 25px;
            text-align: center;
            color: #34495e;
        }

        #welcome-message {
            text-align: center;
            font-size: 1.1em;
            color: #34495e;
            margin-bottom: 20px;
        }

        #initial-load-instructions {
            padding: 15px;
            background-color: #fdfdfe;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            margin-bottom: 25px;
        }

        #initial-load-instructions ul {
            padding-left: 20px;
            color: #555;
        }

        #initial-load-instructions li {
            margin-bottom: 8px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #4a5568;
        }

        label.inline-label {
            display: inline-block;
            margin-bottom: 0;
            margin-left: 5px;
            font-weight: normal;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            max-width: 400px;
            padding: 10px 12px;
            margin-bottom: 15px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
        }

        select {
            width: auto;
            min-width: 150px;
            margin-bottom: 5px;
        }

        input[type="number"].short-input {
            width: 80px !important;
            margin-left: 10px;
            display: inline-block;
        }

        #exam-duration-setup-input {
            width: 100px;
            margin-bottom: 10px;
        }

        #question-container {
            margin-bottom: 20px;
            padding: 20px;
            background-color: #f9fafb;
            border-radius: 6px;
            border: 1px solid #e4e7eb;
        }

        #question {
            margin-bottom: 20px;
            font-size: 1.25em;
            font-weight: 500;
            color: #34495e;
        }

        #timer {
            margin-bottom: 20px;
            font-size: 1.1em;
            font-weight: 500;
            color: #c0392b;
            background-color: #fef2f2;
            padding: 10px 15px;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #fecaca;
        }

        @keyframes breathe {
            0% {
                background-color: #ffdddd;
            }

            50% {
                background-color: #ffcccc;
            }

            100% {
                background-color: #ffdddd;
            }
        }

        .timer-warning {
            animation: breathe 1.5s infinite;
        }

        .choice {
            margin-bottom: 12px;
            background-color: #fff;
            border: 1px solid #e2e8f0;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
        }

        .choice:hover {
            background-color: #f8fafc;
            border-color: #cbd5e0;
        }

        .choice input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.1);
            accent-color: #3498db;
        }

        .choice label {
            margin-bottom: 0;
            font-weight: normal;
            color: #333;
            flex-grow: 1;
        }

        .explanation {
            margin-top: 15px;
            padding: 12px;
            background-color: #e8f6f3;
            border-left: 4px solid #1abc9c;
            border-radius: 0 4px 4px 0;
            color: #138d75;
            font-size: 0.95em;
        }

        #results-container {
            margin-top: 30px;
            border: 1px solid #e2e8f0;
            padding: 25px;
            border-radius: 6px;
            background-color: #f9fafb;
        }

        #results-container h2 {
            text-align: center;
            font-size: 1.8em;
            margin-bottom: 20px;
        }

        .review-link {
            cursor: pointer;
            color: #3498db;
            font-weight: 500;
        }

        .review-link:hover {
            text-decoration: underline;
        }

        .button-base {
            padding: 10px 18px;
            font-size: 1em;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            color: white;
            display: inline-block;
            font-weight: 500;
        }

        .button-base:disabled {
            background-color: #bdc3c7 !important;
            cursor: not-allowed;
        }

        #start-button {
            background-color: #27ae60;
            margin: 20px auto 0;
            display: block;
            font-size: 1.2em;
        }

        .nav-button {
            background-color: #3498db;
            margin: 5px 3px;
        }

        #submit-button {
            background-color: #16a085;
        }

        #load-url-button,
        #browse-file-button {
            background-color: #5dade2;
            width: 100%;
            margin-bottom: 5px;
        }

        #run-demo-button {
            background-color: #f39c12;
            width: 100%;
            margin-top: 15px;
        }

        #progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            margin-bottom: 8px;
            border-radius: 8px;
            height: 12px;
            overflow: hidden;
        }

        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: #2ecc71;
            transition: width 0.4s ease-in-out;
        }

        #progress-text {
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9em;
            color: #555;
        }

        #exam-setup-options {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #e0e6ed;
            border-radius: 6px;
            background-color: #fdfdfe;
        }

        .setup-option-group {
            margin-bottom: 15px;
        }

        .setup-details {
            margin-left: 25px;
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }

        #custom-domain-selection {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #eee;
            padding: 10px;
            border-radius: 4px;
            background-color: #fff;
        }

        .domain-checkbox-item {
            display: block;
            margin-bottom: 5px;
        }

        #effective-settings-summary {
            margin-top: 15px;
            padding: 10px;
            background-color: #eaf2f8;
            border: 1px solid #d1e0ec;
            border-radius: 4px;
            color: #2c3e50;
        }

        .time-flag {
            color: #e74c3c;
            margin-left: 10px;
            display: inline-flex;
            align-items: center;
        }

        .domain-result {
            margin-bottom: 8px;
            padding: 10px 12px;
            background-color: #eaf2f8;
            border-left: 4px solid #3498db;
            border-radius: 4px;
        }

        @media (max-width: 600px) {
            #exam-container {
                width: 100%;
                padding: 15px;
            }
        }
    </style>
</head>

<body>

    <div id="exam-container">
        <h1 id="exam-title">Open Exam Application</h1>
        <p id="welcome-message"></p>

        <div id="initial-load-instructions">
            <p id="custom-instructions-text"></p>
            <div id="default-instructions-text">
                <p>Instructions:</p>
                <ul>
                    <li>Select an exam bank by loading from a URL or local file(s).</li>
                    <li>Alternatively, run the built-in Demo Exam.</li>
                    <li>Once loaded, configure questions and time limit.</li>
                    <li>Click 'Start Exam' to begin.</li>
                </ul>
            </div>

            <label for="json-url">Load from URL (optional):</label>
            <input type="text" id="json-url" placeholder="Enter JSON URL...">
            <button id="load-url-button" class="button-base">Load from URL</button>

            <div style="margin-top: 20px; margin-bottom: 15px;">
                <hr style="border: 0; border-top: 1px solid #e0e6ed;">
            </div>

            <div id="file-input-container">
                <label for="browse-file-button">Load from Local File(s):</label>
                <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;">(You can select multiple JSON files to
                    merge them)</div>
                <input type="file" id="json-file" accept=".json" multiple style="display: none;">
                <button id="browse-file-button" class="button-base">Browse Files</button>
                <span id="selected-file-name">No file selected</span>
            </div>
            <button id="run-demo-button" class="button-base">Run Demo Exam</button>
        </div>

        <div id="exam-setup-options" style="display: none;">
            <h4>Exam Setup</h4>
            <div class="setup-option-group">
                <input type="radio" id="setup-default" name="exam-setup-type" value="default" checked>
                <label for="setup-default" class="inline-label">Use default settings from exam file</label>
                <div id="default-settings-info" class="setup-details"></div>
            </div>
            <div class="setup-option-group">
                <input type="radio" id="setup-quick" name="exam-setup-type" value="quick">
                <label for="setup-quick" class="inline-label">Quick Start (Random questions from all topics)</label>
            </div>
            <div class="setup-option-group">
                <input type="radio" id="setup-custom-domain" name="exam-setup-type" value="custom_domain">
                <label for="setup-custom-domain" class="inline-label">Custom Selection (Choose specific topics)</label>
                <div id="custom-domain-options-container" class="setup-details" style="display: none;">
                    <p>Select one or more topics:</p>
                    <div id="custom-domain-selection"></div>
                </div>
            </div>

            <div class="setup-option-group">
                <input type="radio" id="setup-real-exam" name="exam-setup-type" value="real_exam">
                <label for="setup-real-exam" class="inline-label" style="font-weight:bold; color:#2c3e50;">Real Exam
                    Mode (100 Questions, 2 Hours, Strict)</label>
            </div>

            <div class="setup-option-group">
                <input type="checkbox" id="show-time-warning-checkbox">
                <label for="show-time-warning-checkbox" class="inline-label">Show time warning on questions</label>
            </div>

            <div id="custom-exam-common-options" style="display: none;">
                <hr style="border: 0; border-top: 1px solid #e0e6ed;">
                <div>
                    <label for="custom-question-count-select">Number of Questions:</label>
                    <select id="custom-question-count-select">
                        <option value="5">5</option>
                        <option value="10">10</option>
                        <option value="20">20</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="custom">Custom...</option>
                    </select>
                    <input type="number" id="custom-question-count-input" min="1" class="short-input"
                        style="display: none;" placeholder="Qty">
                </div>
                <div>
                    <label for="exam-duration-setup-input">Time Limit (minutes, 0 for unlimited):</label>
                    <input type="number" id="exam-duration-setup-input" min="0" value="60">
                </div>
                <p id="custom-setup-warning"></p>
            </div>

            <p id="effective-settings-summary"></p>
            <button id="start-button" class="button-base">Start Exam</button>
        </div>


        <div id="progress-bar-container" style="display: none;">
            <div id="progress-bar"></div>
        </div>
        <p id="progress-text" style="display: none;"></p>
        <div id="timer" style="display: none;">Time Remaining: <span id="time-remaining"></span></div>

        <div id="question-container" style="display: none;">
            <div id="question"></div>
            <button id="back-button" class="nav-button button-base" disabled>Back</button>
            <button id="next-button" class="nav-button button-base">Next</button>
            <button id="submit-button" class="nav-button button-base" style="display: none;">Submit</button>
        </div>

        <div id="results-container" style="display: none;">
            <h2>Results</h2>
            <p>Correct Answers: <span id="correct-answers"></span></p>
            <p>Incorrect Answers: <span id="incorrect-answers"></span></p>
            <p>Unanswered: <span id="unanswered-questions"></span></p>
            <p>Percentage: <span id="percentage"></span>%</p>
            <p>Confidence Score: <span id="confidence-score"></span></p>
            <p>Average Time per Question: <span id="average-time"></span></p>
            <h3>Results by Domain (Best to Worst)</h3>
            <div id="domain-results"></div>
            <p>Review Questions:</p>
            <p>Correct: <span id="correct-review" class="review-link"></span></p>
            <p>Incorrect: <span id="incorrect-review" class="review-link"></span></p>
            <p>Unanswered: <span id="unanswered-review" class="review-link"></span></p>
        </div>

        <div id="review-container" style="display: none;">
            <h3>Review Questions</h3>
            <div id="review-list"></div>
            <button id="review-return-button" class="nav-button button-base">Return to Results</button>
        </div>

        <div id="version-info"></div>
    </div>

    <script>
        const APP_VERSION = "1.9.1 (Fixed)";
        const DEBUG = true;

        const defaultExamData = {
            "Exam Name": "Demo Exam",
            "Number of Questions": 3, "Default Time": 1, "BackNavigation": true,
            "Questions": [
                { "DomainOfKnowledge": "JavaScript Basics", "Question": "Output of console.log(2+2)?", "Choices": ["22", "4", "0"], "AnswerKey": "4", "Explaination": "2+2=4" },
                { "DomainOfKnowledge": "JavaScript Basics", "Question": "Variable keyword?", "Choices": ["var", "int", "float"], "AnswerKey": "var", "Explaination": "var/let/const" },
                { "DomainOfKnowledge": "DOM", "Question": "Select by ID?", "Choices": ["#id", "getElementById", "query"], "AnswerKey": "getElementById", "Explaination": "getElementById" }
            ]
        };

        let examData = null;
        let currentQuestionIndex = 0, userAnswers = {}, correctAnswersCount = 0, incorrectAnswersCount = 0;
        let timerInterval, timeRemaining, examStartTime;
        let correctQuestionsList = [], incorrectQuestionsList = [], unansweredQuestionsList = [];
        let randomizedExamData = [], maxQuestionsInBank = 0, isBackNavigationDisabled = false;
        let questionStartTime = 0, confidenceScores = [], avgTimePerQuestionForConfidence = 0;
        let showTimeWarning = false, questionTimeSpent = [];
        const TIME_PER_QUESTION_SECONDS = 90;

        let currentExamSetup = { type: 'default', numQuestions: 0, totalTimeMinutes: 0, selectedDomains: [] };

        // DOM Elements
        const elements = {
            initialLoadInstructions: document.getElementById('initial-load-instructions'),
            examSetupOptions: document.getElementById('exam-setup-options'),
            setupDefaultRadio: document.getElementById('setup-default'),
            customDomainOptionsContainer: document.getElementById('custom-domain-options-container'),
            customDomainSelection: document.getElementById('custom-domain-selection'),
            customExamCommonOptions: document.getElementById('custom-exam-common-options'),
            customQuestionCountSelect: document.getElementById('custom-question-count-select'),
            customQuestionCountInput: document.getElementById('custom-question-count-input'),
            customSetupWarning: document.getElementById('custom-setup-warning'),
            examDurationSetupInput: document.getElementById('exam-duration-setup-input'),
            effectiveSettingsSummary: document.getElementById('effective-settings-summary'),
            showTimeWarningCheckbox: document.getElementById('show-time-warning-checkbox'),
            questionContainer: document.getElementById('question-container'),
            choicesContainer: document.getElementById('question-container'), // reusing container for appending choices
            questionElement: document.getElementById('question'),
            backButton: document.getElementById('back-button'),
            nextButton: document.getElementById('next-button'),
            submitButton: document.getElementById('submit-button'),
            timerDiv: document.getElementById('timer'),
            timeRemainingSpan: document.getElementById('time-remaining'),
            resultsContainer: document.getElementById('results-container'),
            correctAnswersSpan: document.getElementById('correct-answers'),
            incorrectAnswersSpan: document.getElementById('incorrect-answers'),
            unansweredQuestionsSpan: document.getElementById('unanswered-questions'),
            percentageSpan: document.getElementById('percentage'),
            domainResultsDiv: document.getElementById('domain-results'),
            startButton: document.getElementById('start-button'),
            runDemoButton: document.getElementById('run-demo-button'),
            browseFileButton: document.getElementById('browse-file-button'),
            selectedFileNameSpan: document.getElementById('selected-file-name'),
            jsonFileInput: document.getElementById('json-file'),
            jsonUrlInput: document.getElementById('json-url'),
            loadUrlButton: document.getElementById('load-url-button'),
            examTitle: document.getElementById('exam-title'),
            welcomeMessage: document.getElementById('welcome-message'),
            customInstructionsText: document.getElementById('custom-instructions-text'),
            defaultInstructionsText: document.getElementById('default-instructions-text'),
            progressBarContainer: document.getElementById('progress-bar-container'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            averageTimeSpan: document.getElementById('average-time'),
            confidenceScoreSpan: document.getElementById('confidence-score'),
            correctReviewSpan: document.getElementById('correct-review'),
            incorrectReviewSpan: document.getElementById('incorrect-review'),
            unansweredReviewSpan: document.getElementById('unanswered-review'),
            reviewContainer: document.getElementById('review-container'),
            reviewList: document.getElementById('review-list'),
            reviewReturnButton: document.getElementById('review-return-button'),
            versionInfo: document.getElementById('version-info')
        };

        function setupEventListeners() {
            elements.startButton.addEventListener('click', startActualExam);
            elements.backButton.addEventListener('click', goBack);
            elements.nextButton.addEventListener('click', goNext);
            elements.submitButton.addEventListener('click', submitActualExam);
            elements.reviewReturnButton.addEventListener('click', returnToResults);
            elements.loadUrlButton.addEventListener('click', loadExamDataFromUrl);
            if (elements.browseFileButton) elements.browseFileButton.addEventListener('click', () => elements.jsonFileInput.click());
            elements.jsonFileInput.addEventListener('change', handleFileSelectAndLoad);
            elements.runDemoButton.addEventListener('click', startDemoExam);

            document.querySelectorAll('input[name="exam-setup-type"]').forEach(radio => {
                radio.addEventListener('change', handleSetupTypeChange);
            });
            elements.customQuestionCountSelect.addEventListener('change', handleQuestionCountSelectChange);
            elements.customQuestionCountInput.addEventListener('input', updateCurrentExamSetup);
            elements.examDurationSetupInput.addEventListener('input', updateCurrentExamSetup);
            elements.showTimeWarningCheckbox.addEventListener('change', (e) => { showTimeWarning = e.target.checked; });
        }

        window.addEventListener('DOMContentLoaded', () => {
            if (elements.versionInfo) elements.versionInfo.innerText = `Exam System v${APP_VERSION}`;
            setupEventListeners();
        });

        // --- File Loading Logic ---

        function loadExamData(data, sourceName) {
            examData = data;
            elements.examTitle.innerText = examData["Exam Name"] || "Untitled Exam";
            elements.welcomeMessage.innerText = `Loaded: ${sourceName}`;
            elements.selectedFileNameSpan.innerText = sourceName;
            elements.defaultInstructionsText.style.display = 'none';

            if (examData["Instructions"]) {
                elements.customInstructionsText.innerText = examData["Instructions"];
                elements.customInstructionsText.style.display = 'block';
            } else {
                elements.customInstructionsText.style.display = 'none';
            }

            maxQuestionsInBank = examData["Questions"] ? examData["Questions"].length : 0;
            elements.examSetupOptions.style.display = 'block';
            elements.setupDefaultRadio.click(); // Reset to default
            renderCustomDomainOptions();
            updateCurrentExamSetup();
        }

        function handleFileSelectAndLoad(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            if (files.length === 1) {
                const file = files[0];
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        if (validateExamData(data)) loadExamData(data, file.name);
                    } catch (error) { alert("Invalid JSON file."); console.error(error); }
                };
                reader.readAsText(file);
            } else {
                const readers = [];
                const loadedData = [];
                let filesProcessed = 0;
                for (let i = 0; i < files.length; i++) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (data.Questions) loadedData.push(data);
                        } catch (error) { console.error(`Error parsing ${files[i].name}`, error); }
                        filesProcessed++;
                        if (filesProcessed === files.length) mergeAndLoadExams(loadedData, files.length);
                    };
                    reader.readAsText(files[i]);
                }
            }
        }

        function mergeAndLoadExams(dataList, fileCount) {
            if (dataList.length === 0) { alert("No valid exam data found."); return; }

            // Merge Strategy
            let combinedQuestions = [];
            dataList.forEach(d => { if (d.Questions) combinedQuestions = combinedQuestions.concat(d.Questions); });

            const mergedExam = {
                "Exam Name": `Merged Exam (${fileCount} files)`,
                "Questions": combinedQuestions,
                "Default Time": Math.round(combinedQuestions.length * 1.5),
                "DomainPercentages": {} // Reset percentages as they might not align
            };
            loadExamData(mergedExam, `Merged (${fileCount} files)`);
        }

        function loadExamDataFromUrl() {
            const url = elements.jsonUrlInput.value.trim();
            if (!url) return;
            fetch(url).then(r => r.json()).then(d => {
                if (validateExamData(d)) loadExamData(d, url);
            }).catch(e => alert("Failed to load URL: " + e));
        }

        function startDemoExam() { loadExamData(defaultExamData, "Demo Exam"); }

        function validateExamData(data) {
            if (!data || !data.Questions) { alert("Invalid Data"); return false; }
            return true;
        }

        // --- Setup & Questions Logic ---

        function renderCustomDomainOptions() {
            if (!examData.Questions) return;
            const domains = [...new Set(examData.Questions.map(q => q.DomainOfKnowledge))].sort();
            elements.customDomainSelection.innerHTML = '';
            if (domains.length === 0) { elements.customDomainSelection.innerHTML = '<p>No topics.</p>'; return; }
            domains.forEach(d => {
                const div = document.createElement('div'); div.className = 'domain-checkbox-item';
                const cb = document.createElement('input'); cb.type = 'checkbox'; cb.value = d; cb.id = `dom-${d.replace(/\s+/g, '')}`; cb.name = 'selectedDomain';
                const lbl = document.createElement('label'); lbl.htmlFor = cb.id; lbl.textContent = d; lbl.className = 'inline-label';
                div.append(cb, lbl); elements.customDomainSelection.appendChild(div);
                cb.addEventListener('change', updateCurrentExamSetup);
            });
        }

        function handleSetupTypeChange() {
            const type = document.querySelector('input[name="exam-setup-type"]:checked').value;
            currentExamSetup.type = type;

            elements.customDomainOptionsContainer.style.display = (type === 'custom_domain') ? 'block' : 'none';
            document.getElementById('default-settings-info').style.display = (type === 'default') ? 'block' : 'none';

            // Real Exam hides standard counts
            elements.customExamCommonOptions.style.display = (type === 'quick' || type === 'custom_domain') ? 'block' : 'none';

            updateCurrentExamSetup();
        }

        function updateCurrentExamSetup() {
            if (!examData) return;
            const type = currentExamSetup.type;
            let numQ = 0, timeM = 0, summary = "";
            isBackNavigationDisabled = false;

            if (type === 'default') {
                numQ = Math.min(examData["Number of Questions"], maxQuestionsInBank);
                timeM = examData["Default Time"];
                if (examData["BackNavigation"] === false) isBackNavigationDisabled = true;
                summary = `Default: ${numQ} Qs, ${timeM} mins.`;
            } else if (type === 'real_exam') {
                // Strict Mode
                numQ = 100;
                timeM = 120;
                isBackNavigationDisabled = true;
                summary = `<strong>REAL EXAM MODE</strong>: 100 Qs (ISC2 Weighted), 120 Mins. Strict Navigation.`;
                if (maxQuestionsInBank < 100) {
                    numQ = maxQuestionsInBank;
                    summary += `<br><span style="color:red">(Only ${numQ} questions available - using max)</span>`;
                }
            } else {
                // Custom/Quick
                let poolSize = maxQuestionsInBank;
                if (type === 'custom_domain') {
                    const sel = Array.from(elements.customDomainSelection.querySelectorAll('input:checked')).map(c => c.value);
                    currentExamSetup.selectedDomains = sel;
                    poolSize = examData.Questions.filter(q => sel.includes(q.DomainOfKnowledge)).length;
                    if (sel.length === 0) elements.customSetupWarning.innerText = "Select a topic.";
                    else elements.customSetupWarning.innerText = "";
                }

                let reqQ = (elements.customQuestionCountSelect.value === 'custom') ?
                    parseInt(elements.customQuestionCountInput.value) || 0 : parseInt(elements.customQuestionCountSelect.value);
                numQ = Math.min(reqQ, poolSize);
                timeM = parseInt(elements.examDurationSetupInput.value) || 0;
                summary = `Custom: ${numQ} Qs, ${timeM} mins.`;
            }

            currentExamSetup.numQuestions = numQ;
            currentExamSetup.totalTimeMinutes = timeM;
            elements.effectiveSettingsSummary.innerHTML = summary;
            elements.startButton.disabled = (numQ <= 0);
        }

        function handleQuestionCountSelectChange() {
            if (elements.customQuestionCountSelect.value === 'custom') {
                elements.customQuestionCountInput.style.display = 'inline-block';
            } else {
                elements.customQuestionCountInput.style.display = 'none';
            }
            updateCurrentExamSetup();
        }

        function startActualExam() {
            updateCurrentExamSetup();
            if (currentExamSetup.numQuestions <= 0) return;

            // Prepare Questions
            if (currentExamSetup.type === 'real_exam') {
                randomizedExamData = prepareRealExamQuestions(currentExamSetup.numQuestions, examData.Questions);
                alert("REAL EXAM STARTED.\n120 Minutes.\nNo Backtracking.");
            } else if (currentExamSetup.type === 'custom_domain') {
                let pool = examData.Questions.filter(q => currentExamSetup.selectedDomains.includes(q.DomainOfKnowledge));
                shuffleArray(pool);
                randomizedExamData = pool.slice(0, currentExamSetup.numQuestions);
            } else if (currentExamSetup.type === 'default' && examData.DomainPercentages) {
                randomizedExamData = prepareQuestionsByPercentage(currentExamSetup.numQuestions, examData.DomainPercentages, examData.Questions);
            } else {
                // Quick / Fallback
                let pool = [...examData.Questions];
                shuffleArray(pool);
                randomizedExamData = pool.slice(0, currentExamSetup.numQuestions);
            }

            // Init UI
            elements.initialLoadInstructions.style.display = 'none';
            elements.examSetupOptions.style.display = 'none';
            elements.questionContainer.style.display = 'block';
            elements.timerDiv.style.display = 'block';
            elements.progressBarContainer.style.display = 'block';
            elements.progressText.style.display = 'block';

            // Init State
            currentQuestionIndex = 0;
            userAnswers = {};
            correctAnswersCount = 0; incorrectAnswersCount = 0;
            examStartTime = Date.now();
            questionTimeSpent = []; confidenceScores = [];

            // Timer
            if (currentExamSetup.totalTimeMinutes > 0) {
                timeRemaining = currentExamSetup.totalTimeMinutes * 60;
                startTimerInterval();
            } else {
                elements.timeRemainingSpan.innerText = "Unlimited";
            }

            showQuestion();
        }

        // --- Question Handling ---

        function prepareRealExamQuestions(targetCount, allQuestions) {
            const weights = { "Domain 1": 0.26, "Domain 2": 0.10, "Domain 3": 0.22, "Domain 4": 0.24, "Domain 5": 0.18 };
            const buckets = { "Domain 1": [], "Domain 2": [], "Domain 3": [], "Domain 4": [], "Domain 5": [], "Other": [] };

            // Categorize
            allQuestions.forEach(q => {
                let d = "Other";
                if (q.DomainOfKnowledge.includes("Domain 1")) d = "Domain 1";
                else if (q.DomainOfKnowledge.includes("Domain 2")) d = "Domain 2";
                else if (q.DomainOfKnowledge.includes("Domain 3")) d = "Domain 3";
                else if (q.DomainOfKnowledge.includes("Domain 4")) d = "Domain 4";
                else if (q.DomainOfKnowledge.includes("Domain 5")) d = "Domain 5";
                buckets[d].push(q);
            });

            let selected = [];
            // Weighted Fill
            for (const [dom, weight] of Object.entries(weights)) {
                if (selected.length >= targetCount) break;
                const count = Math.round(targetCount * weight);
                shuffleArray(buckets[dom]);
                const chunk = buckets[dom].slice(0, count);
                selected = selected.concat(chunk);
            }

            // Fill Remainder
            if (selected.length < targetCount) {
                let unused = [];
                Object.values(buckets).forEach(arr => unused = unused.concat(arr));
                unused = unused.filter(q => !selected.includes(q));
                shuffleArray(unused);
                selected = selected.concat(unused.slice(0, targetCount - selected.length));
            }

            shuffleArray(selected);
            return selected.slice(0, targetCount);
        }

        function prepareQuestionsByPercentage(target, percentages, all) {
            // Basic impl
            let selected = [];
            const buckets = {};
            all.forEach(q => {
                if (!buckets[q.DomainOfKnowledge]) buckets[q.DomainOfKnowledge] = [];
                buckets[q.DomainOfKnowledge].push(q);
            });

            for (const [dom, perc] of Object.entries(percentages)) {
                const count = Math.floor(target * (perc / 100));
                if (buckets[dom]) {
                    shuffleArray(buckets[dom]);
                    selected = selected.concat(buckets[dom].slice(0, count));
                }
            }
            // Fill remaining
            if (selected.length < target) {
                let unused = all.filter(q => !selected.includes(q));
                shuffleArray(unused);
                selected = selected.concat(unused.slice(0, target - selected.length));
            }
            shuffleArray(selected);
            return selected;
        }

        function showQuestion() {
            questionStartTime = Date.now();
            elements.timerDiv.classList.remove('timer-warning');
            const qData = randomizedExamData[currentQuestionIndex];
            elements.questionElement.innerText = `${currentQuestionIndex + 1}. ${qData.Question}`;

            // Clear choices
            const existing = elements.choicesContainer.querySelectorAll('.choice');
            existing.forEach(e => e.remove());

            // Render Choices
            qData.Choices.forEach((c, i) => {
                const div = document.createElement('div'); div.className = 'choice';
                const rad = document.createElement('input'); rad.type = 'radio'; rad.name = 'answer'; rad.value = c; rad.id = `c${i}`;
                const lbl = document.createElement('label'); lbl.htmlFor = `c${i}`; lbl.innerText = c;
                div.append(rad, lbl);
                div.addEventListener('click', (e) => { if (e.target !== rad && e.target.tagName !== 'LABEL') rad.checked = true; });

                elements.choicesContainer.insertBefore(div, elements.backButton); // insert above nav buttons
            });

            // Restore User Answer
            if (userAnswers[currentQuestionIndex]) {
                const r = elements.choicesContainer.querySelector(`input[value="${CSS.escape(userAnswers[currentQuestionIndex])}"]`);
                if (r) r.checked = true;
            }

            // Buttons
            if (isBackNavigationDisabled) {
                elements.backButton.style.display = 'none';
            } else {
                elements.backButton.style.display = 'inline-block';
                elements.backButton.disabled = (currentQuestionIndex === 0);
            }

            if (currentQuestionIndex === randomizedExamData.length - 1) {
                elements.nextButton.style.display = 'none';
                elements.submitButton.style.display = 'inline-block';
            } else {
                elements.nextButton.style.display = 'inline-block';
                elements.submitButton.style.display = 'none';
            }

            // Progress
            const perc = ((currentQuestionIndex + 1) / randomizedExamData.length) * 100;
            elements.progressBar.style.width = `${perc}%`;
            elements.progressText.innerText = `Question ${currentQuestionIndex + 1} / ${randomizedExamData.length}`;
        }

        function goNext() {
            try {
                if (currentExamSetup.type === 'real_exam') {
                    const picked = elements.choicesContainer.querySelector('input[name="answer"]:checked');
                    if (!picked) { alert("Real Exam: Select an answer."); return; }
                    if (!confirm("Confirm Answer? You cannot go back.")) return;
                }
                saveAnswer();
                calculateScore();
                currentQuestionIndex++;
                showQuestion();
            } catch (e) {
                alert("Error moving to next question: " + e.message);
                console.error(e);
            }
        }

        function goBack() {
            if (isBackNavigationDisabled) return;
            saveAnswer();
            calculateScore();
            currentQuestionIndex--;
            showQuestion();
        }

        function saveAnswer() {
            const picked = elements.choicesContainer.querySelector('input[name="answer"]:checked');
            if (picked) userAnswers[currentQuestionIndex] = picked.value;
        }

        function calculateScore() {
            if (!randomizedExamData[currentQuestionIndex]) return;
            const timeSpent = (Date.now() - questionStartTime) / 1000;
            questionTimeSpent[currentQuestionIndex] = timeSpent;

            const correct = userAnswers[currentQuestionIndex] === randomizedExamData[currentQuestionIndex].AnswerKey;
            let s = 0;
            // Simplified confidence logic
            if (correct) s = 100; else s = -50;
            confidenceScores[currentQuestionIndex] = s;
        }

        function startTimerInterval() {
            timerInterval = setInterval(() => {
                timeRemaining--;
                const m = Math.floor(timeRemaining / 60);
                const s = timeRemaining % 60;
                elements.timeRemainingSpan.innerText = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;

                if (timeRemaining <= 0) { clearInterval(timerInterval); alert("Time's up!"); submitActualExam(); }
            }, 1000);
        }

        function submitActualExam() {
            saveAnswer(); calculateScore(); clearInterval(timerInterval);
            elements.questionContainer.style.display = 'none';
            elements.timerDiv.style.display = 'none';
            elements.resultsContainer.style.display = 'block';
            elements.startButton.style.display = 'block'; // Allow restart?

            // Stats
            const total = randomizedExamData.length;
            let correct = 0, incorrect = 0, unanswered = 0;
            const domainStats = {};

            correctQuestionsList = []; incorrectQuestionsList = []; unansweredQuestionsList = [];

            for (let i = 0; i < total; i++) {
                const q = randomizedExamData[i];
                const ua = userAnswers[i];
                const dom = q.DomainOfKnowledge;

                if (!domainStats[dom]) domainStats[dom] = { c: 0, t: 0 };
                domainStats[dom].t++;

                if (!ua) { unanswered++; unansweredQuestionsList.push(i); }
                else if (ua === q.AnswerKey) { correct++; correctQuestionsList.push(i); domainStats[dom].c++; }
                else { incorrect++; incorrectQuestionsList.push(i); }
            }

            const scorePerc = (correct / total) * 100;
            elements.percentageSpan.innerText = scorePerc.toFixed(2);
            elements.correctAnswersSpan.innerText = `${correct}/${total}`;
            elements.incorrectAnswersSpan.innerText = `${incorrect}/${total}`;
            elements.unansweredQuestionsSpan.innerText = `${unanswered}/${total}`;

            // Verdict
            if (scorePerc >= 70) elements.percentageSpan.innerHTML += " <span style='color:green'>(PASSED)</span>";
            else elements.percentageSpan.innerHTML += " <span style='color:red'>(FAILED)</span>";

            // Domain Results
            elements.domainResultsDiv.innerHTML = "";
            Object.keys(domainStats).forEach(d => {
                const s = domainStats[d];
                const p = s.t > 0 ? (s.c / s.t) * 100 : 0;
                const div = document.createElement('div'); div.className = 'domain-result';
                div.innerText = `${d}: ${s.c}/${s.t} (${p.toFixed(1)}%)`;
                elements.domainResultsDiv.appendChild(div);
            });

            // Review Links
            elements.correctReviewSpan.innerText = `Review (${correct})`;
            elements.correctReviewSpan.onclick = () => reviewList(correctQuestionsList);

            elements.incorrectReviewSpan.innerText = `Review (${incorrect})`;
            elements.incorrectReviewSpan.onclick = () => reviewList(incorrectQuestionsList);

            elements.unansweredReviewSpan.innerText = `Review (${unanswered})`;
            elements.unansweredReviewSpan.onclick = () => reviewList(unansweredQuestionsList);
        }

        function reviewList(indices) {
            if (indices.length === 0) return;
            elements.resultsContainer.style.display = 'none';
            elements.reviewContainer.style.display = 'block';

            elements.reviewList.innerHTML = "";
            indices.forEach(idx => {
                const q = randomizedExamData[idx];
                const d = document.createElement('div'); d.className = 'review-list-item';
                d.innerHTML = `<strong>Q${idx + 1}:</strong> ${q.Question}<br>
                       <span style="color:${userAnswers[idx] === q.AnswerKey ? 'green' : 'red'}">Your Answer: ${userAnswers[idx] || 'None'}</span><br>
                       <strong>Correct:</strong> ${q.AnswerKey}<br>
                       <em>${q.Explaination}</em>`;
                elements.reviewList.appendChild(d);
            });
        }

        function returnToResults() {
            elements.reviewContainer.style.display = 'none';
            elements.resultsContainer.style.display = 'block';
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
    </script>
</body>

</html>